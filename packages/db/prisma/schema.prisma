generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}

// -----------------------------------------------------------------------------
// CORE IDENTITY & ORGANIZATION
// -----------------------------------------------------------------------------

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students      Student[]
  staff         Staff[]
  academicYears AcademicYear[]
  courses       Course[]
  classSections ClassSection[]
  users         User[]
}

model SourceSystem {
  id         String    @id @default(uuid())
  name       String    @unique // "Toddle", "IXL", "OneRoster"
  config     Json? // API keys, endpoints (encrypted if sensitive)
  lastSyncAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  externalIdentifiers ExternalIdentifier[]
}

// Crosswalk table to link Internal IDs to External Source IDs
model ExternalIdentifier {
  id             String       @id @default(uuid())
  entityType     String // "Student", "Staff", "ClassSection", etc.
  entityId       String // The internal UUID of the entity
  sourceSystem   SourceSystem @relation(fields: [sourceSystemId], references: [id])
  sourceSystemId String
  sourceId       String // The ID in the external system (e.g., Toddle ID, IXL User ID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sourceSystemId, sourceId, entityType])
  @@index([entityId, entityType])
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  PARENT
  USER // Fallback for existing schema compatibility
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String? // Optional if using SSO
  role         UserRole @default(USER)
  displayName  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenancy
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  // Profile Links
  studentProfile Student?
  staffProfile   Staff?

  // Existing schema compatibility
  sessions   Session[]
  adminNotes AdminNote[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
}

model Student {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id])
  userId         String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  // Demographics
  firstName String?
  lastName  String?
  dob       DateTime?
  gender    String?

  // Flexible Data
  customFields  Json? // Toddle custom fields
  rawSourceData Json? // Full raw payload from sync

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  families       FamilyMember[]
  enrollments    Enrollment[]
  attendance     AttendanceRecord[]
  behavior       BehaviorIncident[]
  gradeEntries   GradeEntry[]
  ixlDiagnostics IXLDiagnosticSnapshot[]
  ixlSkillUsage  IXLSkillUsage[]
  ixlSkillPlans  StudentSkillPlanProgress[]
}

model Staff {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id])
  userId         String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  jobTitle String?
  isAdmin  Boolean @default(false)

  rawSourceData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  classSections     ClassSection[] // Primary teacher
  enrollments       Enrollment[] // Co-teachers/support
  reportedIncidents BehaviorIncident[]
}

model Family {
  id   String  @id @default(uuid())
  name String? // e.g. "The Smith Family"

  rawSourceData Json?

  members   FamilyMember[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model FamilyMember {
  id        String  @id @default(uuid())
  family    Family  @relation(fields: [familyId], references: [id])
  familyId  String
  student   Student @relation(fields: [studentId], references: [id])
  studentId String

  relationship String // "Father", "Mother", "Guardian"
  isPrimary    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([familyId, studentId])
}

// -----------------------------------------------------------------------------
// ACADEMIC STRUCTURE
// -----------------------------------------------------------------------------

model AcademicYear {
  id             String       @id @default(uuid())
  name           String // "2023-2024"
  startDate      DateTime
  endDate        DateTime
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  terms         AcademicTerm[]
  classSections ClassSection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AcademicTerm {
  id             String       @id @default(uuid())
  name           String // "Semester 1", "Term 2"
  startDate      DateTime
  endDate        DateTime
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  academicYearId String

  gradingPeriods GradingPeriod[]
  classSections  ClassSection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GradingPeriod {
  id             String       @id @default(uuid())
  name           String
  academicTerm   AcademicTerm @relation(fields: [academicTermId], references: [id])
  academicTermId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Curriculum {
  id          String  @id @default(uuid())
  name        String // "IB MYP", "Common Core"
  description String?

  courses Course[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GradeLevel {
  id   String @id @default(uuid())
  name String // "Grade 5", "Year 6"

  courses Course[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Course {
  id             String       @id @default(uuid())
  name           String // "Mathematics 101"
  code           String?
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  curriculum   Curriculum? @relation(fields: [curriculumId], references: [id])
  curriculumId String?
  gradeLevel   GradeLevel? @relation(fields: [gradeLevelId], references: [id])
  gradeLevelId String?

  classSections ClassSection[]
  ixlSkillPlans IXLSkillPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClassSection {
  id             String       @id @default(uuid())
  name           String // "Math 101 - Section A"
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  course   Course @relation(fields: [courseId], references: [id])
  courseId String

  academicYear   AcademicYear  @relation(fields: [academicYearId], references: [id])
  academicYearId String
  academicTerm   AcademicTerm? @relation(fields: [academicTermId], references: [id])
  academicTermId String?

  primaryTeacher Staff?  @relation(fields: [staffId], references: [id])
  staffId        String?

  enrollments    Enrollment[]
  assignments    Assignment[]
  attendance     AttendanceRecord[]
  timetableSlots TimetableSlot[]

  rawSourceData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EnrollmentRole {
  STUDENT
  TEACHER
  OBSERVER
}

model Enrollment {
  id             String       @id @default(uuid())
  classSection   ClassSection @relation(fields: [classSectionId], references: [id])
  classSectionId String

  // Polymorphic-ish relation (can be Student or Staff)
  student   Student? @relation(fields: [studentId], references: [id])
  studentId String?
  staff     Staff?   @relation(fields: [staffId], references: [id])
  staffId   String?

  role      EnrollmentRole
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classSectionId, studentId]) // Ensure unique enrollment per student per class
}

// -----------------------------------------------------------------------------
// OPERATIONS (TODDLE)
// -----------------------------------------------------------------------------

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model AttendanceRecord {
  id             String        @id @default(uuid())
  student        Student       @relation(fields: [studentId], references: [id])
  studentId      String
  classSection   ClassSection? @relation(fields: [classSectionId], references: [id]) // If class-based
  classSectionId String?

  date    DateTime         @db.Date
  status  AttendanceStatus
  code    String? // Specific code from Toddle (e.g., "Illness")
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, date])
}

enum BehaviorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model BehaviorIncident {
  id         String  @id @default(uuid())
  student    Student @relation(fields: [studentId], references: [id])
  studentId  String
  reportedBy Staff?  @relation(fields: [staffId], references: [id])
  staffId    String?

  title        String
  description  String?
  severity     BehaviorSeverity @default(LOW)
  incidentDate DateTime

  rawSourceData Json? // Store categories, actions taken

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TimetableSlot {
  id             String       @id @default(uuid())
  classSection   ClassSection @relation(fields: [classSectionId], references: [id])
  classSectionId String

  day       String // "Monday", "Day 1"
  startTime String // "09:00"
  endTime   String // "10:00"
  location  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// LEARNING & GRADING (TODDLE)
// -----------------------------------------------------------------------------

enum AssignmentType {
  FORMATIVE
  SUMMATIVE
  PROJECT
  HOMEWORK
}

enum MypCriterion {
  A
  B
  C
  D
}

model Assignment {
  id             String       @id @default(uuid())
  classSection   ClassSection @relation(fields: [classSectionId], references: [id])
  classSectionId String

  title       String
  description String?
  type        AssignmentType?
  dueDate     DateTime?
  maxScore    Float?

  grades GradeEntry[]

  rawSourceData Json? // Rubrics, specific tool data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classSectionId, dueDate])
}

model GradeEntry {
  id           String     @id @default(uuid())
  student      Student    @relation(fields: [studentId], references: [id])
  studentId    String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  assignmentId String

  score    Float?
  grade    String? // Letter grade or level
  feedback String?

  criteriaScores GradeEntryCriterion[]

  isSubmitted Boolean   @default(false)
  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, assignmentId])
  @@index([studentId])
  @@index([assignmentId])
}

model GradeEntryCriterion {
  id           String       @id @default(uuid())
  gradeEntry   GradeEntry   @relation(fields: [gradeEntryId], references: [id], onDelete: Cascade)
  gradeEntryId String

  criterion MypCriterion
  score     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gradeEntryId, criterion])
  @@index([gradeEntryId])
}

// -----------------------------------------------------------------------------
// IXL SPECIFIC MODULE
// -----------------------------------------------------------------------------

model IXLSkillPlan {
  id      String  @id @default(uuid())
  title   String
  subject String?

  course   Course? @relation(fields: [courseId], references: [id])
  courseId String?

  rawSourceData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentProgress StudentSkillPlanProgress[]
}

model StudentSkillPlanProgress {
  id          String       @id @default(uuid())
  student     Student      @relation(fields: [studentId], references: [id])
  studentId   String
  skillPlan   IXLSkillPlan @relation(fields: [skillPlanId], references: [id])
  skillPlanId String

  skillsMastered Int @default(0)
  totalSkills    Int @default(0)

  updatedAt DateTime @updatedAt

  @@unique([studentId, skillPlanId])
}

model IXLDiagnosticSnapshot {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id])
  studentId String

  subject        String // "Math", "Language Arts"
  scoreRangeLow  Int
  scoreRangeHigh Int
  snapshotDate   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IXLSkillUsage {
  id        String  @id @default(uuid())
  student   Student @relation(fields: [studentId], references: [id])
  studentId String

  skillCode         String
  questionsAnswered Int
  timeSpentSeconds  Int
  smartScore        Int
  lastPracticed     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, skillCode])
}

// -----------------------------------------------------------------------------
// LEGACY / ADMIN
// -----------------------------------------------------------------------------

model AdminNote {
  id        String   @id @default(cuid())
  authorId  String
  pageKey   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([pageKey])
}
