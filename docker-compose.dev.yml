services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev-web
    env_file:
      - ./.env
    environment:
      NEXT_TELEMETRY_DISABLED: 1
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
      REDIS_URL: redis://redis:6379
    command: ["npm", "run", "dev", "--workspace", "@school-analytics/web"]
    volumes:
      - ./.env:/workspace/apps/web/.env:ro
    develop:
      watch:
        - action: sync
          path: ./apps/web
          target: /workspace/apps/web
          initial_sync: true
          ignore:
            - node_modules/
            - .next/
        - action: sync
          path: ./packages/db
          target: /workspace/packages/db
          initial_sync: true
          ignore:
            - node_modules/
            - src/generated/
        - action: rebuild
          path: ./package.json
        - action: rebuild
          path: ./package-lock.json
        - action: rebuild
          path: ./apps/web/package.json
        - action: rebuild
          path: ./packages/db/package.json
    ports:
      - "${WEB_PORT:-3000}:3000"

  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev-worker
    env_file:
      - ./.env
    environment:
      CHOKIDAR_USEPOLLING: "true"
      REDIS_URL: redis://redis:6379
    command: ["npm", "run", "dev", "--workspace", "@school-analytics/worker"]
    volumes:
      - ./.env:/workspace/apps/worker/.env:ro
      - ./apps/worker/saved_responses:/workspace/apps/worker/saved_responses
    develop:
      watch:
        - action: sync
          path: ./apps/worker
          target: /workspace/apps/worker
          initial_sync: true
          ignore:
            - node_modules/
            - saved_responses/
        - action: sync
          path: ./packages/db
          target: /workspace/packages/db
          initial_sync: true
          ignore:
            - node_modules/
            - src/generated/
        - action: sync
          path: ./packages/ingestion
          target: /workspace/packages/ingestion
          initial_sync: true
          ignore:
            - node_modules/
        - action: rebuild
          path: ./package.json
        - action: rebuild
          path: ./package-lock.json
        - action: rebuild
          path: ./apps/worker/package.json
        - action: rebuild
          path: ./packages/db/package.json
        - action: rebuild
          path: ./packages/ingestion/package.json

  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev-scheduler
    env_file:
      - ./.env
    environment:
      CHOKIDAR_USEPOLLING: "true"
      REDIS_URL: redis://redis:6379
    command: ["npm", "run", "dev", "--workspace", "@school-analytics/scheduler"]
    volumes:
      - ./.env:/workspace/apps/scheduler/.env:ro
    develop:
      watch:
        - action: sync
          path: ./apps/scheduler
          target: /workspace/apps/scheduler
          initial_sync: true
          ignore:
            - node_modules/
        - action: sync
          path: ./packages/db
          target: /workspace/packages/db
          initial_sync: true
          ignore:
            - node_modules/
            - src/generated/
        - action: rebuild
          path: ./package.json
        - action: rebuild
          path: ./package-lock.json
        - action: rebuild
          path: ./apps/scheduler/package.json
        - action: rebuild
          path: ./packages/db/package.json
